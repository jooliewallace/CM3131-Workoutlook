<!DOCTYPE html>
<html>

<head>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css" />
    <title>Google Maps API Example</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
    </style>
</head>

<body>
    <ion-datetime-button datetime="datetime"></ion-datetime-button>

    <ion-modal>
        <ion-datetime id="datetime"></ion-datetime>
    </ion-modal>
    <div id="map"></div>

    <div>Total Distance: <span id="distance">0.00</span> km</div>
    <div><span id="weather"></span></div>
    <div>
        <label for="route-name">Route name:</label>
        <input type="text" id="route-name">
        <button onclick="clearRoute()">Clear route</button>
    </div>
    <div>
        <button onclick="saveRoute()">Save route</button>
    </div>

    <script async
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDV1DfvaQczVj43_srRMHyZaxClqJRApU0&callback=initMap" async
        defer></script>
    <script>
        var map, markers = [], lines = [], directionsService, directionsRenderer;
        var routes = [];

        function initMap() {
            // Initialize the map
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 37.7749, lng: -122.4194 },
                zoom: 13
            });

            // Initialize the directions service and renderer
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                map: map
            });

            // Add a listener for clicks on the map to add a new marker
            map.addListener('click', function (event) {
                addMarker(event.latLng);
                calculateDistance();
                if (markers.length === 1) {
                    getWeather(event.latLng);
                }
            });

            function addRoute(route) {
                // Create a new polyline and add it to the map
                var path = route.markers.map(function (marker) {
                    return new google.maps.LatLng(marker.lat, marker.lng);
                });
                var polyline = new google.maps.Polyline({
                    path: path,
                    map: map,
                    strokeColor: '#0000FF',
                    strokeOpacity: 0.7,
                    strokeWeight: 4
                });


                // Open a connection to the IndexedDB database
                var request = window.indexedDB.open('routesDB', 1);

                // Create the object store for routes if it doesn't exist
                request.onupgradeneeded = function (event) {
                    var db = event.target.result;
                    if (!db.objectStoreNames.contains('routes')) {
                        var store = db.createObjectStore('routes', { keyPath: 'id', autoIncrement: true });
                    }
                };


                // Add a listener for clicks on the polyline to delete it
                polyline.addListener('click', function (event) {
                    deleteRoute(polyline);
                });
            }

            function clearRoute() {
                // Remove all markers from the map
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                markers = [];

                // Remove all lines from the map
                for (var i = 0; i < lines.length; i++) {
                    lines[i].setMap(null);
                }
                lines = [];

                // Clear the directions renderer
                directionsRenderer.setDirections({});

                // Reset the distance display
                document.getElementById('distance').textContent = '0.00';
            }


            function addMarker(location) {
                // Create a new marker and add it to the map
                var marker = new google.maps.Marker({
                    position: location,
                    map: map
                });
                markers.push(marker);

                // If there are at least two markers, calculate the route and display it
                if (markers.length > 1) {
                    // Calculate the route and display it
                    calculateRoute();

                    // Draw lines between all the markers
                    var path = markers.map(function (marker) {
                        return marker.getPosition();
                    });
                    var line = new google.maps.Polyline({
                        path: path,
                        map: map
                    });
                    lines.push(line);
                }

                // If this is the first marker, get the weather at this location and time
                if (markers.length === 1) {
                    getWeather(location);
                }
            }


            function deleteMarker(index) {
                // Remove the marker from the map and the array
                markers[index].setMap(null);
                markers.splice(index, 1);

                // Remove the corresponding line from the map and the array
                lines[index].setMap(null);
                lines.splice(index, 1);

                // Recalculate the route and display it
                calculateRoute();

                // Recalculate the distance and display it
                calculateDistance();
            }

            function addRoute(route) {
                // Create a new polyline and add it to the map
                var path = route.markers.map(function (marker) {
                    return new google.maps.LatLng(marker.lat, marker.lng);

                });
                var polyline = new google.maps.Polyline({
                    path: path,
                    map: map,
                    strokeColor: '#0000FF',
                    strokeOpacity: 0.7,
                    strokeWeight: 4
                });


                // Add a listener for clicks on the polyline to delete it
                polyline.addListener('click', function (event) {
                    deleteRoute(polyline);
                });


            }

            function clearRoute() {
                // Remove all markers from the map
                for (var i = 0; i < markers.length; i++) {
                    markers[i].setMap(null);
                }
                markers = [];

                // Remove all lines from the map
                for (var i = 0; i < lines.length; i++) {
                    lines[i].setMap(null);
                }
                lines = [];

                // Clear the directions renderer
                directionsRenderer.setDirections({});

                // Reset the distance display
                document.getElementById('distance').innerHTML = '0.00';
            }


            function deleteRoute(polyline) {
                // Remove the polyline from the map and the array
                polyline.setMap(null);
                var index = lines.indexOf(polyline);
                if (index !== -1) {
                    lines.splice(index, 1);
                }
            }
            var route = {
                name: 'My Route',
                distance: '10.00 km',
                markers: [
                    { lat: 37.7749, lng: -122.4194 },
                    { lat: 37.8716, lng: -122.2727 }
                ]
            };

            addRoute(route);

            function calculateRoute() {
                // If there are at least two markers, calculate the route and display it
                if (markers.length > 1) {
                    var waypoints = markers.slice(1, -1).map(function (marker) {
                        return {
                            location: marker.getPosition(),
                            stopover: true
                        };
                    });
                    var origin = markers[0].getPosition();
                    var destination = markers[markers.length - 1].getPosition();
                    var request = {
                        origin: origin,
                        destination: destination,
                        waypoints: waypoints,
                        travelMode: 'WALKING'
                    };
                    directionsService.route(request, function (result, status) {
                        if (status == 'OK') {
                            directionsRenderer.setDirections(result);
                        }
                    });
                }
            }

            function calculateDistance() {
                var totalDistance = 0;
                for (var i = 0; i < markers.length - 1; i++) {
                    totalDistance += google.maps.geometry.spherical.computeDistanceBetween(markers[i].getPosition(), markers[i + 1].getPosition());
                }
                document.getElementById('distance').innerHTML = (totalDistance / 1000).toFixed(2);
            }
        }

        function getWeather(location) {
            const apiKey = 'f7e12627407bf5695eebfd813ed35fd6';
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${location.lat()}&lon=${location.lng()}&units=metric&appid=${apiKey}`;
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    const weather = data.weather[0].main;
                    const temp = data.main.temp;
                    var windSpeed = data.wind.speed;

                    document.getElementById('weather').textContent = `Weather: ${weather}, Temperature: ${temp}Â°C, WindSpeed: ${windSpeed}`;
                })
                .catch(error => {
                    console.error(error);
                });
        }

        // Open a connection to the IndexedDB database
        var request = window.indexedDB.open('routesDB', 1);

        // Create the object store for routes if it doesn't exist
        request.onupgradeneeded = function (event) {
            var db = event.target.result;
            if (!db.objectStoreNames.contains('routes')) {
                var store = db.createObjectStore('routes', { keyPath: 'id', autoIncrement: true });
            }
        };

        function saveRoute() {

            if (!Array.isArray(markers)) {
                markers = [];

                // Create a new route object with the name, distance, and markers
                var datetime = document.getElementById('datetime').value; // Get the date and time value
                var weather = document.getElementById('weather').textContent;
                var name = document.getElementById('route-name').value;
                var distance = document.getElementById('distance').textContent;
                var markers = markers.map(function (marker) {
                    return { lat: marker.getPosition().lat(), lng: marker.getPosition().lng() };
                });
                var route = { datetime: datetime, name: name, distance: distance, markers: markers, weather: weather };

                // Open a connection to the IndexedDB database
                var request = window.indexedDB.open('routesDB', 1);

                // Add the route object to the 'routes' object store
                request.onsuccess = function (event) {
                    var db = event.target.result;
                    var transaction = db.transaction(['routes'], 'readwrite');
                    var store = transaction.objectStore('routes');
                    var addRequest = store.add(route);
                    addRequest.onsuccess = function (event) {
                        console.log('Route added to IndexedDB');
                    };

                    addRequest.onerror = function (event) {
                        console.error('Error adding route to IndexedDB');
                    };
                };
            }
        }

    </script>